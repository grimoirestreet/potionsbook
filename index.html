<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grimoire Street • Potions Compendium (1890s)</title>
<style>
  :root{
    --bg:#15181d; --panel:#1e232a; --side:#1b1f25; --ink:#eef0f3; --muted:#aab0ba;
    --line:#282d35; --accent:#d3ba7c; --pill:#262b33; --pill-soft:#222730;
  }
  html,body{background:var(--bg); color:var(--ink); margin:0; overflow-y:auto}
  body{font-family:"Inter",ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; line-height:1.55}
  *,*::before,*::after{box-sizing:border-box}
  .wrap{max-width:1120px; margin:28px auto; padding:0 16px}

  h1{margin:0 0 2px 0; font-size:clamp(26px,3.2vw,38px); font-weight:700; letter-spacing:.01em; color:var(--accent)}
  .sub{color:var(--muted); font-size:14px}
  .rule{height:1px; background:var(--line); margin:16px 0 18px}

  .grid{display:grid; grid-template-columns:300px 1fr; gap:18px; align-items:start}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}

  .side{position:static; align-self:start; background:var(--side); border:1px solid var(--line); border-radius:14px; padding:12px}
  @media(min-width:981px){.side.is-sticky{position:sticky; top:12px; will-change:top}}
  .side h2{margin:0 0 10px 0; font-size:13px; color:var(--muted); letter-spacing:.04em; text-transform:uppercase}
  .field{display:grid; gap:6px; margin-bottom:12px}
  .field label{font-size:12px; color:var(--muted)}
  .input, select{width:100%; background:var(--panel); color:var(--ink); border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:14px; line-height:1.2}
  .input::placeholder{color:#c6cbd3; opacity:.85}
  .seg{display:flex; gap:8px; flex-wrap:wrap}
  .seg button{flex:1; background:var(--pill); border:1px solid var(--line); color:var(--ink); padding:8px 10px; border-radius:999px; cursor:pointer; font-size:13px}
  .seg button[aria-pressed="true"]{background:var(--accent); color:#0d0e10; font-weight:600}

  .legend{border-top:1px solid var(--line); margin-top:8px; padding-top:10px}
  .legend h3{margin:0 0 6px 0; font-size:12px; color:var(--muted); letter-spacing:.03em; text-transform:uppercase}
  .legend-top{background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:10px 12px; margin:12px 0 18px}
  .chips{display:flex; flex-wrap:wrap; gap:6px}
  .chip{background:var(--pill-soft); border:1px solid var(--line); color:#d9dde6; padding:6px 10px; border-radius:999px; font-size:12px}
  .chip[data-lvl="Elementary"]{color:#cfe8ff}
  .chip[data-lvl="Intermediate"]{color:#e8d6ff}
  .chip[data-lvl="Advanced"]{color:#ffe7c7}
  .chip[data-lvl="Master"]{color:#ffbdbd}

  .tabs{display:flex; flex-direction:column; border-top:1px solid var(--line); margin-top:10px}
  .tabs button{appearance:none; background:transparent; border:none; text-align:left; padding:10px 12px; border-bottom:1px solid var(--line); cursor:pointer; color:#cfd5de; font-size:14px}
  .tabs button[aria-current="true"]{background:var(--panel); color:var(--accent); font-weight:600}

  .panel{background:var(--panel); border:1px solid var(--line); border-radius:14px; overflow:hidden; align-self:start}
  .panel header{padding:14px; border-bottom:1px solid var(--line)}
  .panel h3{margin:0; font-size:18px; font-weight:700; letter-spacing:.01em; color:var(--accent)}
  .how{padding:10px 14px; border-bottom:1px dashed var(--line); color:var(--muted); font-size:14px}

  .list{display:grid}
  details.item{border-bottom:1px solid var(--line)}
  details.item[open] summary{background:#1d2128}
  summary{list-style:none; cursor:pointer; padding:12px 14px; display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; scroll-margin-top:16px}
  summary::-webkit-details-marker{display:none}
  .name{font-weight:600}
  .namewrap{min-width:0}
  .effect-preview{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
  .pill{display:inline-block; padding:3px 8px; border-radius:999px; background:var(--pill); border:1px solid var(--line); font-size:12px; color:#cfd5de}
  .meta{display:flex; gap:8px; align-items:center}
  .body{padding:10px 14px 14px 14px}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media(max-width:700px){.grid-2{grid-template-columns:1fr}}
  .spec{background:#1d2128; border:1px solid var(--line); border-radius:10px; padding:10px}
  .spec dt{font-size:12px; color:#c9ced8}
  .spec dd{margin:0 0 8px 0}
  .notes{color:#b7bdc7; font-size:13px; margin-top:8px}
  .empty{padding:16px; color:#b7bdc7}
  .footer{margin-top:16px; color:#b7bdc7; font-size:12px; text-align:center}
  a{color:var(--accent)}
  .helper{margin-top:10px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Grimoire Street • Potions Compendium</h1>
      <div class="sub">Hogwarts Legacy era (1890s). Canon-only by default. Toggle OC to include approved originals.</div>
    </header>
    <div class="rule" aria-hidden="true"></div>

    <section class="legend legend-top" aria-label="Legend">
      <h3>Legend • who can brew?</h3>
      <div class="chips">
        <span class="chip" data-lvl="Elementary">Elementary → Years 1–2</span>
        <span class="chip" data-lvl="Intermediate">Intermediate → Years 3–5</span>
        <span class="chip" data-lvl="Advanced">Advanced → Years 6–7</span>
        <span class="chip" data-lvl="Master">Master → Faculty & Adults only</span>
        <span class="chip">Banned/Controlled per Hogwarts policy</span>
      </div>
    </section>

    <div class="grid">
      <aside class="side" role="complementary">
        <h2>Browse</h2>
        <div class="field">
          <label for="q">Search potions</label>
          <input id="q" class="input" type="text" placeholder="Search name, effect, ingredients, notes…" />
        </div>
        <div class="field">
          <label for="dif">Difficulty</label>
          <select id="dif">
            <option value="">All</option>
            <option>Elementary</option>
            <option>Intermediate</option>
            <option>Advanced</option>
            <option>Master</option>
          </select>
        </div>
        <div class="field">
          <label for="year">Year group</label>
          <select id="year">
            <option value="">Any</option>
            <option value="y12">Years 1–2</option>
            <option value="y35">Years 3–5</option>
            <option value="y67">Years 6–7</option>
            <option value="post">Post-grad / Adult</option>
          </select>
        </div>
        <div class="field">
          <label>Mode</label>
          <div class="seg" role="group" aria-label="Mode">
            <button id="modeCanon" aria-pressed="true">Canon</button>
            <button id="modeAll" aria-pressed="false">Canon + OC</button>
          </div>
        </div>
        <div class="tabs" role="tablist" aria-label="Potion Types"></div>
        <div class="helper">
          Staff shortcut: <a id="editLink" href="#" target="_blank" rel="noopener">Edit potions-data.json</a>
        </div>
      </aside>

      <main class="panel" role="region" aria-live="polite">
        <header><h3 id="subjectTitle">Loading…</h3></header>
        <div class="how"><strong>RP use:</strong> Choose a potion type, then search or filter. Keep brewing within your character’s allowed year group/difficulty. Banned & Combat potions require admin-approved plots. OC potions show only in Canon+OC mode after staff approval.</div>
        <section id="list" class="list"><div class="empty">Loading potions…</div></section>
      </main>
    </div>
    <p class="footer">Report missing or era-inaccurate potions to staff.</p>
  </div>

<script>
/** CONFIG: root-level JSON + edit link **/
const DATA_URL = 'potions-data.json'; // root file (no folders)
const EDIT_DATA_URL = 'https://github.com/grimoirestreet/potionsbook/edit/main/potions-data.json';
document.getElementById('editLink').href = EDIT_DATA_URL;

/** DOM helpers **/
const $ = s => document.querySelector(s);
const listEl = $('#list');
const sideEl = document.querySelector('.side');
const sideTabs = document.querySelector('.tabs');
const subjectTitle = $('#subjectTitle');

/** Sticky aside **/
function updateSticky(){
  const fits = window.innerWidth >= 981 && (sideEl.scrollHeight + 24) <= window.innerHeight;
  sideEl.classList.toggle('is-sticky', fits);
}

/** State **/
const state = { q:'', dif:'', year:'', subject:'', oc:false };
let POTIONS = []; // flat array of potions with {type, oc, ...}
let TYPES = [];   // strings

function buildTabs(){
  sideTabs.innerHTML='';
  TYPES.forEach(t=>{
    const b=document.createElement('button');
    b.textContent=t;
    b.setAttribute('aria-current', String(state.subject===t));
    b.addEventListener('click', ()=>{ state.subject=t; render(); });
    sideTabs.appendChild(b);
  });
}

function allowedByYear(dif){
  if(!state.year) return true;
  switch(state.year){
    case 'y12': return dif==='Elementary';
    case 'y35': return dif==='Elementary'||dif==='Intermediate';
    case 'y67': return dif==='Elementary'||dif==='Intermediate'||dif==='Advanced';
    case 'post': return true;
    default: return true;
  }
}
function matches(pt){
  if(state.dif && pt.difficulty!==state.dif) return false;
  if(!allowedByYear(pt.difficulty)) return false;
  if(!state.oc && pt.oc) return false;
  if(state.q){
    const blob=[
      pt.name, pt.effect, pt.ingredients, pt.notes, pt.restriction,
      pt.appearance, pt.inventor, pt.source
    ].filter(Boolean).join(' ').toLowerCase();
    if(!blob.includes(state.q)) return false;
  }
  return true;
}

function makeRow(pt){
  const it=document.createElement('details'); it.className='item';
  const sum=document.createElement('summary');

  const nameWrap=document.createElement('div'); nameWrap.className='namewrap';
  const name=document.createElement('div'); name.className='name'; name.textContent=pt.name;
  const preview=document.createElement('div'); preview.className='effect-preview'; preview.textContent=pt.effect||'—';
  nameWrap.append(name, preview);

  const meta=document.createElement('div'); meta.className='meta';
  const pill1=document.createElement('span'); pill1.className='pill'; pill1.textContent=pt.difficulty||'—';
  meta.appendChild(pill1);
  const pill2=document.createElement('span'); pill2.className='pill'; pill2.textContent=pt.restriction||'—';
  meta.appendChild(pill2);
  if(pt.oc){ const oc=document.createElement('span'); oc.className='pill'; oc.textContent='OC'; meta.appendChild(oc); }

  sum.append(nameWrap, meta);

  const body=document.createElement('div'); body.className='body';
  const specs=document.createElement('div'); specs.className='spec grid-2';
  specs.innerHTML =
    `<dl>
      <dt>Ingredients</dt><dd>${pt.ingredients||'—'}</dd>
      <dt>Brewing Time</dt><dd>${pt.time||'—'}</dd>
      <dt>Appearance/Duration</dt><dd>${[pt.appearance, pt.duration].filter(Boolean).join(' • ')||'—'}</dd>
      <dt>Inventor/Source</dt><dd>${[pt.inventor, pt.source].filter(Boolean).join(' • ')||'—'}</dd>
    </dl>
    <dl>
      <dt>Instructions</dt><dd>${pt.instructions||'—'}</dd>
      <dt>Notes</dt><dd class="notes">${pt.notes||''}</dd>
    </dl>`;
  body.appendChild(specs);

  it.append(sum, body);
  return it;
}

function render(){
  [...sideTabs.children].forEach(btn=> btn.setAttribute('aria-current', String(btn.textContent===state.subject)));
  subjectTitle.textContent = state.subject || 'Potions';

  const items = POTIONS.filter(p=>p.type===state.subject).filter(matches).sort((a,b)=> a.name.localeCompare(b.name));
  listEl.innerHTML='';
  if(!items.length){
    const d=document.createElement('div'); d.className='empty'; d.textContent='No entries. Edit potions-data.json or loosen filters.';
    listEl.appendChild(d); return;
  }
  items.forEach(pt=> listEl.appendChild(makeRow(pt)));
}

async function boot(){
  try{
    const res = await fetch(DATA_URL, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();

    /* ---- Robust normalizer: accepts three shapes ----
       A) raw array: [ {...}, {...} ]
       B) { types: [...], potions: [...] }
       C) grouped object by category:
          { "Healing & Medical":[ {...}, ... ], "Antidotes":[ ... ], ... }
    */
    let potions = [];
    let typesFromFile = [];

    if (Array.isArray(data)) {
      potions = data;
    } else if (data && Array.isArray(data.potions)) {
      potions = data.potions;
      if (Array.isArray(data.types)) typesFromFile = data.types;
    } else if (data && typeof data === 'object') {
      for (const [type, arr] of Object.entries(data)) {
        if (Array.isArray(arr)) {
          for (const p of arr) potions.push({ type, ...p });
          if (!typesFromFile.includes(type)) typesFromFile.push(type);
        }
      }
    }

    // Normalize fields for UI
    POTIONS = potions.map(p => ({
      oc: !!p.oc,
      type: p.type || 'Utility & Academic',
      name: p.name || 'Untitled Potion',
      difficulty: p.difficulty || '',
      restriction: p.restriction || '',
      effect: p.effect || '',
      ingredients: p.ingredients || '',
      instructions: p.instructions || '',
      time: p.time || '',
      notes: p.notes || '',
      appearance: p.appearance || '',
      duration: p.duration || '',
      inventor: p.inventor || '',
      source: p.source || ''
    }));

    TYPES = typesFromFile.length
      ? typesFromFile
      : Array.from(new Set(POTIONS.map(p=>p.type)));

    // Fallback: make sure at least one tab exists
    if (!TYPES.length) TYPES = ['Player-Created Potions'];

    state.subject = TYPES[0];

    buildTabs();
    render();
    updateSticky();
    window.addEventListener('resize', updateSticky);

    // Controls
    $('#q').addEventListener('input', e=>{ state.q=e.target.value.trim().toLowerCase(); render(); });
    $('#dif').addEventListener('change', e=>{ state.dif=e.target.value; render(); });
    $('#year').addEventListener('change', e=>{ state.year=e.target.value; render(); });
    $('#modeCanon').addEventListener('click', ()=>{ state.oc=false; $('#modeCanon').setAttribute('aria-pressed','true'); $('#modeAll').setAttribute('aria-pressed','false'); render(); });
    $('#modeAll').addEventListener('click', ()=>{ state.oc=true;  $('#modeAll').setAttribute('aria-pressed','true');  $('#modeCanon').setAttribute('aria-pressed','false'); render(); });

  }catch(err){
    listEl.innerHTML = `<div class="empty">Could not load <code>${DATA_URL}</code>. Ensure it exists at the repo root and JSON is valid.<br><small>${String(err)}</small></div>`;
  }
}
boot();
</script>
</body>
</html>
